#!/bin/bash

set -euo pipefail

# Paths
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
. "${DIR}/common"
ROOT=$(dirname "${DIR}")

ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)
CLUSTER_NAME="${CLUSTER_NAME:-}"
BUCKET_NAME="${BUCKET_NAME:-gpu-readings}"
REGION="${REGION:-us-east-1}"

# Check for required tools
REQUIRED_TOOLS=(aws eksctl)
has_tools "${REQUIRED_TOOLS[@]}"

# Validate arguments
if [[ -z "${BUCKET_NAME}" ]]; then
  err "Error: BUCKET_NAME is required."
fi
if [[ -z "${REGION}" ]]; then
  err "Error: REGION is required. Defaulting to 'us-east-1'."
fi
if [[ -z "${CLUSTER_NAME}" ]]; then
  err "Error: CLUSTER_NAME is required."
fi
if [[ -z "${ACCOUNT_ID}" ]]; then
  err "Error: Unable to determine AWS Account ID."
fi
if ! eksctl get cluster --name "$CLUSTER_NAME" --region "$REGION" &>/dev/null; then
  err "Error: Cluster '$CLUSTER_NAME' not found in region '$REGION'."
fi

# print configuration
msg "Using the following configuration:"
msg "  AWS Account ID: $ACCOUNT_ID"
msg "  EKS Cluster Name: $CLUSTER_NAME"
msg "  S3 Bucket Name: $BUCKET_NAME"
msg "  AWS Region: $REGION"

# enable OIDC provider for the cluster if not already enabled
eksctl utils associate-iam-oidc-provider \
  --cluster "$CLUSTER_NAME" \
  --region "$REGION" \
  --approve

OIDC_URL=$(aws eks describe-cluster --name "$CLUSTER_NAME" --region "$REGION" \
  --query "cluster.identity.oidc.issuer" --output text)
OIDC_ARN="arn:aws:iam::${ACCOUNT_ID}:oidc-provider/${OIDC_URL#https://}"
msg "$OIDC_URL"
msg "$OIDC_ARN"

# create versioned bucket if it does not exist
if ! aws s3api head-bucket --bucket "$BUCKET_NAME" --region "$REGION" 2>/dev/null; then
  aws s3api create-bucket \
    --bucket "$BUCKET_NAME" \
    --region "$REGION"
fi

aws s3api put-bucket-versioning \
  --bucket "$BUCKET_NAME" \
  --region "$REGION" \
  --versioning-configuration "Status=Enabled"

# Block all public access
aws s3api put-public-access-block \
  --bucket "$BUCKET_NAME" \
  --region "$REGION" \
  --public-access-block-configuration \
    "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"

# write out S3 bucket policy to a temp file if it does not exist
 cat >"bucket-${BUCKET_NAME}.json" <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "WriteObjects",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:AbortMultipartUpload"
      ],
      "Resource": "arn:aws:s3:::${BUCKET_NAME}/*"
    },
    {
      "Sid": "OptionalListForUploader",
      "Effect": "Allow",
      "Action": ["s3:ListBucket"],
      "Resource": "arn:aws:s3:::${BUCKET_NAME}"
    }
  ]
}
EOF

if ! aws iam list-policies --query "Policies[?PolicyName=='${BUCKET_NAME}'].PolicyName" --output text 2>/dev/null | grep -q "${BUCKET_NAME}"; then
  aws iam create-policy \
    --policy-name "$BUCKET_NAME" \
    --policy-document "file://bucket-${BUCKET_NAME}.json"
fi

# create IAM role trust 
cat >"trust-${BUCKET_NAME}.json" <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Federated": "$OIDC_ARN" },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "$OIDC_URL:aud": "sts.amazonaws.com",
          "$OIDC_URL:sub": "system:serviceaccount:observability:s3-writer"
        }
      }
    }
  ]
}}
EOF

# create role and attach the policy if it does not exist
if ! aws iam get-role --role-name "$BUCKET_NAME-writer" &>/dev/null ; then
  aws iam create-role \
    --role-name "$BUCKET_NAME-writer" \
    --assume-role-policy-document "file://trust-${BUCKET_NAME}.json"
fi

aws iam attach-role-policy \
  --role-name "$BUCKET_NAME-writer" \
  --policy-arn "arn:aws:iam::${ACCOUNT_ID}:policy/${BUCKET_NAME}"
